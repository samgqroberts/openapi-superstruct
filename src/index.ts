import { bundle } from 'json-schema-ref-parser'
export interface Params {
  input: string
}

export async function generate({
  input,
}: Params): Promise<void> {
  const spec = await parseInputFileOrThrow(input);
  const schemas = spec?.components?.schemas || {}
  const objects = Object.entries(schemas).map(([modelName, schema]: [string, any]) => {
    if (schema?.type === 'object') {
      const propertiesStr = Object.entries(schema.properties || {}).map(([propertyName, type]: [string, any]) => {
        const sType = type?.type === 'string' ? 's.string()' : 's.unknown()';
        return `  ${propertyName}: ${sType},`
      }).join('\n')
      return `export const s${modelName} = s.object({\n${propertiesStr}\n});`
    }
    return ''
  }).join('\n')
  const file = `/* autogenerated by openapi-superstruct */

import * as s from 'superstruct';

${objects}
`
  console.log(file)
}

const parseInputFileOrThrow = async (location: string): Promise<any> => {
  try {
    const schema = await bundle(location, location, {})
    return schema;
  } catch (e) {
    throw new Error(JSON.stringify(e))
  }
}